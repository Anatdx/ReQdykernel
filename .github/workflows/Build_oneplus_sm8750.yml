name: Build_oneplus_sm8750
on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      DEVICES_NAME:
        description: "ğŸ“è¯·é€‰æ‹©è¦ç¼–è¯‘çš„æœºå‹ï¼š"
        required: true
        type: choice
        options:
          - 'oneplus_13'
          - 'oneplus_ace5_pro'
          - 'oneplus_ace_6'
          - 'oneplus_13t'
          - 'oneplus_pad_2_pro'
          - 'oneplus_ace5_ultra'
          - 'realme_GT7'
          - 'realme_GT7pro'
          - 'realme_GT7pro_Speed'
        default: 'oneplus_ace5_pro'

      keep_original_settings:
        description: "ğŸ“ä¿æŒåŸå†…æ ¸åç§°åŠæ„å»ºæ—¶é—´(ä¸æ‡‚è¯·ä¿æŒé»˜è®¤)"
        required: false
        default: true
        type: boolean

      custom_kernel_suffix:
        description: "âœï¸ è‡ªå®šä¹‰å†…æ ¸åç§°- ä»…åœ¨å–æ¶ˆå‹¾é€‰'ä¿æŒåŸè®¾ç½®'æ—¶æœ‰æ•ˆ(ä¸æ‡‚è¯·ä¿æŒé»˜è®¤)"
        required: false
        default: ''
      
      custom_kernel_time:
        description: "â° è‡ªå®šä¹‰æ„å»ºæ—¶é—´- ä»…åœ¨å–æ¶ˆå‹¾é€‰'ä¿æŒåŸè®¾ç½®'æ—¶æœ‰æ•ˆ(ä¸æ‡‚è¯·ä¿æŒé»˜è®¤)"
        required: false
        default: ''

      enable_feature_z:
        description: "æ·»åŠ å®Œç¾é£é©°"
        required: false
        default: true
        type: boolean

      enable_feature_a:
        description: "å¼€å¯BBGåŸºå¸¦å®ˆæŠ¤"
        required: false
        default: true
        type: boolean

      enable_feature_b:
         description: "é€‰æ‹©ç½‘ç»œè°ƒåº¦"
         required: false
         type: choice
         options:
            - 'FQ_CODEL'
            - 'BBR'
         default: 'FQ_CODEL'
      
      enable_feature_r:
        description: "æ·»åŠ Re-Kernelæ”¯æŒ"
        required: false
        default: false
        type: boolean
       


jobs:
  build:
    name: Build_${{ github.event.inputs.DEVICES_NAME }}
    runs-on: ubuntu-latest
    env:
      DEVICES_NAME:          ${{ github.event.inputs.DEVICES_NAME || 'oneplus_ace5_ultra' }}
      KEEP_ORIGINAL_SETTINGS: ${{ github.event.inputs.keep_original_settings || 'true' }}
      CUSTOM_KERNEL_SUFFIX:   ${{ github.event.inputs.custom_kernel_suffix || '' }}
      CUSTOM_KERNEL_TIME:     ${{ github.event.inputs.custom_kernel_time || '' }}
      ENABLE_FEATURE_Z:       ${{ github.event.inputs.enable_feature_z || 'true' }}
      ENABLE_FEATURE_A:       ${{ github.event.inputs.enable_feature_a || 'true' }}
      ENABLE_FEATURE_B:       ${{ github.event.inputs.enable_feature_b || 'FQ_CODEL' }}
      ENABLE_FEATURE_R:       ${{ github.event.inputs.enable_feature_r || 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: âš™ï¸ Set REPO_MANIFEST (è®¾ç½®å¯¹åº”æœºå‹é…ç½®æ–‡ä»¶)
        run: |
          case "${{ env.DEVICES_NAME }}" in
            oneplus_ace5_pro)
              echo "REPO_MANIFEST=sm8750_b_16.0.0_oneplus_ace5_pro" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_ace5_pro_b" >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo "REPO_MANIFEST=sm8750_b_16.0.0_oneplus_13" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13_b" >> $GITHUB_ENV
              ;;
            oneplus_ace_6)
              echo "REPO_MANIFEST=sm8750_b_16.0.0_ace_6" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_ace_6" >> $GITHUB_ENV
              ;;
            oneplus_13t)
              echo "REPO_MANIFEST=sm8750_b_16.0.0_oneplus_13t" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13t_b" >> $GITHUB_ENV
              ;;
            oneplus_pad_2_pro)
              echo "REPO_MANIFEST=sm8750_b_16.0.0_pad_2_pro" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_pad_2_pro_b" >> $GITHUB_ENV
              ;;
            oneplus_ace5_ultra)
              echo "REPO_MANIFEST=sm8750_b_16.0.0_oneplus_13" >> $GITHUB_ENV
              echo "SCHED_FILE=oneplus_13_b" >> $GITHUB_ENV
              ;;
            realme_GT7)
              echo "SCHED_FILE=none" >> $GITHUB_ENV
              ;;
            realme_GT7pro)
              echo "SCHED_FILE=none" >> $GITHUB_ENV
              ;;
            realme_GT7pro_Speed)
              echo "SCHED_FILE=none" >> $GITHUB_ENV
              ;;
          esac
          if [ "${{ env.KEEP_ORIGINAL_SETTINGS }}" = "true" ] && [ -z "${{ github.event.inputs.custom_kernel_suffix }}" ]; then
            case "${{ env.DEVICES_NAME }}" in
            oneplus_pad_2_pro)
              echo 'DEFAULT_SUFFIX=-android15-8-g5a0ffb447c1d-ab13771415-4k' >> $GITHUB_ENV
              ;;
            oneplus_13)
              echo 'DEFAULT_SUFFIX=-android15-8-gf4dc45704e54-abogki446052083-4k' >> $GITHUB_ENV
              ;;
            realme_GT7)
              echo 'DEFAULT_SUFFIX=-android15-8-gd43086512890-abogki423825152-4k' >> $GITHUB_ENV
              ;;
            oneplus_ace5_pro | oneplus_ace_6 | oneplus_13t | oneplus_ace5_ultra | realme_GT7pro_Speed | realme_GT7pro)
              echo 'DEFAULT_SUFFIX=-android15-8-g29d86c5fc9dd-abogki428889875-4k' >> $GITHUB_ENV
              ;;
          esac
            echo "ä½¿ç”¨åŸå®˜æ ¸åç§°ï¼š${{ env.DEFAULT_SUFFIX }}"
          else
            echo "ä½¿ç”¨è‡ªå®šä¹‰åç§°: ${{ github.event.inputs.custom_kernel_suffix }}"
            echo "DEFAULT_SUFFIX=${{ github.event.inputs.custom_kernel_suffix }}" >> $GITHUB_ENV
          fi
          if [ "${{ env.KEEP_ORIGINAL_SETTINGS }}" = "true" ] && [ -z "${{ github.event.inputs.custom_kernel_time }}" ]; then
            case "${{ env.DEVICES_NAME }}" in
              oneplus_pad_2_pro)
                echo 'KERNEL_TIME=Fri Jul 11 22:46:09 UTC 2025' >> $GITHUB_ENV
                ;;
              oneplus_13)
                echo 'KERNEL_TIME=Fri Sep 19 06:13:40 UTC 2025' >> $GITHUB_ENV
                ;;
              realme_GT7)
                echo 'KERNEL_TIME=Tue Jun 10 12:12:23 UTC 2025' >> $GITHUB_ENV
                ;;
              oneplus_ace5_pro | oneplus_ace_6 | oneplus_13t | oneplus_ace5_ultra | realme_GT7pro_Speed | realme_GT7pro)
                echo 'KERNEL_TIME=Tue Jul  1 19:48:18 UTC 2025' >> $GITHUB_ENV
                ;;
            esac
            echo "ä½¿ç”¨å®˜æ ¸æ—¶é—´: ${{ env.KERNEL_TIME }}"
          else
            echo "ä½¿ç”¨è‡ªå®šä¹‰æ„å»ºæ—¶é—´: ${{ github.event.inputs.custom_kernel_time }}"
            echo "KERNEL_TIME=${{ github.event.inputs.custom_kernel_time }}" >> $GITHUB_ENV
          fi

      - name: ğŸ›  Install dependencies and Initialize repo and sync ï¼ˆå®‰è£…ç¯å¢ƒä¾èµ–+åˆå§‹åŒ–æºç ä»“åº“åŠå·¥å…·é“¾ï¼‰
        run: |
          rm -rf kernel_workspace
          mkdir kernel_workspace
          cd kernel_workspace
          
          sudo apt-mark hold firefox &&
          sudo apt-mark hold libc-bin &&
          sudo apt purge man-db &&
          sudo rm -rf /var/lib/man-db/auto-update &&
          sudo apt update &&
          sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev dos2unix ccache p7zip-full &
          echo "æ­£åœ¨å…‹éš†æºç ä»“åº“..."
          if [ "${DEVICES_NAME}" = "realme_GT7" ] || [ "${DEVICES_NAME}" = "realme_GT7pro" ] || [ "${DEVICES_NAME}" = "realme_GT7pro_Speed" ]; then
            aria2c -s16 -x16 -k1M https://github.com/realme-kernel-opensource/realme_GT7pro-AndroidB-common-source/archive/refs/heads/master.zip -o common.zip
            unzip -q common.zip && 
            mv "realme_GT7pro-AndroidB-common-source-master" common
          else
            aria2c -s16 -x16 -k1M https://github.com/OnePlusOSS/android_kernel_common_oneplus_sm8750/archive/refs/heads/oneplus/${REPO_MANIFEST}.zip -o common.zip
            unzip -q common.zip && 
            mv "android_kernel_common_oneplus_sm8750-oneplus-${REPO_MANIFEST}" common
          fi
            rm -rf common.zip 
          echo "æ­£åœ¨å…‹éš†llvm-clang18å·¥å…·é“¾..."
          mkdir -p clang18 &&
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/clang-r510928.zip -o clang.zip &&
          unzip -q clang.zip -d clang18 &&
          rm -rf clang.zip &
          echo "æ­£åœ¨å…‹éš†æ„å»ºå·¥å…·..." &&
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/build-tools.zip -o build-tools.zip &&
          unzip -q build-tools.zip &&
          rm -rf build-tools.zip &
          wait
          echo "æ‰€æœ‰æºç åŠllvm-Clang18å·¥å…·é“¾åˆå§‹åŒ–å®Œæˆï¼"
          echo "æ­£åœ¨å»é™¤ ABI ä¿æŠ¤ & å»é™¤ dirty åç¼€..."
          rm common/android/abi_gki_protected_exports_* || true
          for f in common/scripts/setlocalversion; do
            sed -i 's/ -dirty//g' "$f"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
          done
          
      - name: ğŸ›  Set ccache DIR(é…ç½®ccacheç›®å½•)
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${{ env.DEVICES_NAME }}" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=3G" >> $GITHUB_ENV
          echo "å½“å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h
          echo "å½“å‰æ„å»ºå†…æ ¸æœºå‹ï¼š${{ env.DEVICES_NAME }}"

      - name: ğŸ“¥ Restore ccache (è½½å…¥å½“å‰æœºå‹çš„ccacheç¼“å­˜)
        uses: actions/cache@v4
        id: ccache-restore
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-neov2-${{ env.DEVICES_NAME }}-${{ runner.os }}-main
          restore-keys: |
            ccache-neov2-${{ env.DEVICES_NAME }}-${{ runner.os }}-
            ccache-neov2-${{ env.DEVICES_NAME }}-
      
      - name: ğŸ“¥ Init ccache (åˆå§‹åŒ–é…ç½®ccache)
        run: |
          # è®¾ç½®ccacheç¯å¢ƒå˜é‡
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="${{ env.CCACHE_MAXSIZE }}"
          
          # ç¡®ä¿ccacheç›®å½•å­˜åœ¨
          mkdir -p "$CCACHE_DIR"
          
          # æ¯æ¬¡è¿è¡Œéƒ½é‡æ–°é…ç½®ç¼“å­˜å¤§å°
          echo "é…ç½®ccacheç¼“å­˜å¤§å°ä¸º: $CCACHE_MAXSIZE"
          ccache -M "$CCACHE_MAXSIZE"
          ccache -o compression=true
          
          # æ˜¾ç¤ºåˆå§‹ç¼“å­˜çŠ¶æ€
          echo "ccacheåˆå§‹çŠ¶æ€:"
          ccache -s
          
          # å¦‚æœç¼“å­˜æ¢å¤å‘½ä¸­ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
          if [ "${{ steps.ccache-restore.outputs.cache-hit }}" == 'true' ]; then
            echo "ccacheç¼“å­˜å‘½ä¸­è¯¦æƒ…:"
            ccache -sv
          fi
         
      - name: ğŸ”§ apply lz4 1.10.0 & zstd 1.5.7 patches (æ·»åŠ lz4 1.10.0 & zstd 1.5.7è¡¥ä¸)
        run: |
          echo "æ­£åœ¨æ·»åŠ lz4 1.10.0 & zstd 1.5.7è¡¥ä¸â€¦"
          cd kernel_workspace
          git clone https://github.com/cctv18/oppo_oplus_realme_sm8750.git
          cp ./oppo_oplus_realme_sm8750/zram_patch/001-lz4.patch ./common
          cp ./oppo_oplus_realme_sm8750/zram_patch/lz4armv8.S ./common/lib
          cp ./oppo_oplus_realme_sm8750/zram_patch/002-zstd.patch ./common/
          cd ./common
          git apply -p1 < 001-lz4.patch || true
          patch -p1 < 002-zstd.patch || true
          
      - name: ğŸ”§ Set Baseband-guard (å¼€å¯BBGåŸºå¸¦å®ˆæŠ¤)
        if: ${{ env.ENABLE_FEATURE_A }}
        run: |
          cd kernel_workspace/common
          echo "æ­£åœ¨å¯ç”¨BBGåŸºå¸¦å®ˆæŠ¤â€¦"
          curl -LSs https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' ./security/Kconfig

      - name: âš™ï¸ Set SuKiSU Ultra (è®¾ç½®SuKiSU Ultra)
        run: |
          set -e
          cd kernel_workspace
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" -o setup.sh
          bash setup.sh susfs-main
          cd KernelSU

          KSU_API_VERSION=$(curl -fsSL "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/Makefile" | \
            grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]')
          if [[ -z "$KSU_API_VERSION" || "$(printf '%s\n' "$KSU_API_VERSION" "3.1.7" | sort -V | head -n1)" != "3.1.7" ]]; then
            KSU_API_VERSION="3.1.7"
          fi
          echo "KSU_API_VERSION=$KSU_API_VERSION" >> $GITHUB_ENV

          GIT_HASH=$(git rev-parse --short HEAD)
          echo "GIT_HASH=$GIT_HASH"

          VERSION_FULL="v$KSU_API_VERSION-$GIT_HASH@Anatdx"

          # æ¸…ç†å¹¶å†™å…¥ Makefile ç‰ˆæœ¬ä¿¡æ¯
          sed -i '/define get_ksu_version_full/,/endef/d' kernel/Makefile
          sed -i '/KSU_VERSION_API :=/d' kernel/Makefile
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Makefile

          VERSION_DEFINITIONS=$(cat <<EOF
            define get_ksu_version_full
            $VERSION_FULL
            endef

            KSU_VERSION_API := $KSU_API_VERSION
            KSU_VERSION_FULL := $VERSION_FULL
          EOF
          )

          awk -v def="$VERSION_DEFINITIONS" '
            /REPO_OWNER :=/ {print; print def; inserted=1; next}
            1
            END {if (!inserted) print def}
          ' kernel/Makefile > kernel/Makefile.tmp && mv kernel/Makefile.tmp kernel/Makefile

          KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 37185)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV

          echo "::group::æœ€ç»ˆ Makefile ä¸­ç‰ˆæœ¬ä¿¡æ¯åŠéƒ¨åˆ†è°ƒè¯•ç»“æœé¢„è§ˆ"
          grep -A10 "REPO_OWNER" kernel/Makefile
          grep "KSU_VERSION_FULL" kernel/Makefile
          echo "::endgroup::"

      - name: ğŸ“¥ Kernel Version Handling (è·å–å†…æ ¸ç‰ˆæœ¬)
        run: |
          cd kernel_workspace/kernel_platform
          # è·å–å†…æ ¸ Android ç‰ˆæœ¬å·(KANDROID_VERSION)ä»¥åŠå†…æ ¸ç‰ˆæœ¬å·(KERNEL_VERSION)
          for f in ./common/build.config.constants ./common/build.config.common; do
            if [ -f "$f" ]; then
              BRANCH=$(grep -m1 '^BRANCH=' "$f" | cut -d= -f2)
              [ -n "$BRANCH" ] && break
            fi
          done

          if [ -n "$BRANCH" ]; then
            echo "KANDROID_VERSION=${BRANCH%-*}" >> $GITHUB_ENV
            echo "KERNEL_VERSION=${BRANCH#*-}" >> $GITHUB_ENV
          else
            echo "No BRANCH found in build.config files"
          fi

          # ä» Makefile è·å–å®Œæ•´å†…æ ¸ç‰ˆæœ¬å·(TKERNEL_VERSION)ä»¥åŠå¯é€‰çš„ä¿®æ”¹å†…æ ¸ç­‰çº§
          ORIG_VERSION=$(awk '/^VERSION =/ {v=$3} /^PATCHLEVEL =/ {p=$3} /^SUBLEVEL =/ {s=$3} END {print v"."p"."s}' ./common/Makefile)

          # å¼ºåˆ¶ä¿®æ”¹ SUBLEVEL(å†…æ ¸ç­‰çº§)ï¼Œé»˜è®¤å…³é—­
          # sed -i 's/^SUBLEVEL[[:space:]]*=[[:space:]]*.*/SUBLEVEL = 99/' ./common/Makefile

          # è¯»å–ä¿®æ”¹åçš„ç‰ˆæœ¬
          NEW_VERSION=$(awk '/^VERSION =/ {v=$3} /^PATCHLEVEL =/ {p=$3} /^SUBLEVEL =/ {s=$3} END {print v"."p"."s}' ./common/Makefile)

          if [ "$ORIG_VERSION" != "$NEW_VERSION" ]; then
            echo "Kernel Version:$ORIG_VERSION->$NEW_VERSION"
            echo "TKERNEL_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          else
            echo "Kernel Version:$ORIG_VERSION No changes"
            echo "TKERNEL_VERSION=$ORIG_VERSION" >> $GITHUB_ENV
          fi

      - name: ğŸ”§ Set up SUSFS (é…ç½® SUSFS)
        run: |
          cd kernel_workspace
          echo "æ­£åœ¨æ·»åŠ SukiSU Ultraè¡¥ä¸..."
          git clone https://github.com/ShirkNeko/susfs4ksu.git -b gki-android15-6.6
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          cp ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-android15-6.6.patch ./common/
          cp ./susfs4ksu/kernel_patches/fs/* ./common/fs/
          cp ./susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/
          cp ./SukiSU_patch/69_hide_stuff.patch ./common/
          cd ./common
          patch -p1 < 50_add_susfs_in_gki-android15-6.6.patch || true
    
      - name: ğŸ”§ Set gki_defconfig (è®¾ç½®ç¼–è¯‘é…ç½®) 
        run: |
          cd kernel_workspace
          echo "CONFIG_KSU=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KPM=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4HC=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_LZ4KD=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_CRYPTO_ZSTD=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_COMPRESSION=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_LZ4=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_LZ4HC=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_F2FS_FS_ZSTD=y" >> ./common/arch/arm64/configs/gki_defconfig

          if [ "${{ env.ENABLE_B }}" = "BBR" ]; then
            echo "CONFIG_TCP_CONG_ADVANCED=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_BBR=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_FQ=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_BIC=n" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_CUBIC=n" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_WESTWOOD=n" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_TCP_CONG_HTCP=n" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> ./common/arch/arm64/configs/gki_defconfig
          fi
          if [ "${{ env.ENABLE_B }}" = "FQ_CODEL" ]; then
            echo "CONFIG_NET_SCH_FQ_CODEL=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_FQ=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_SFQ=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_HTB=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_TBF=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_SFB=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_RED=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NET_SCH_INGRESS=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_DEFAULT_FQ_CODEL=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo 'CONFIG_DEFAULT_NET_SCH="fq_codel"' >> ./common/arch/arm64/configs/gki_defconfig
          fi
          echo "CONFIG_IP_ECN=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_ECN=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IPV6_ECN=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_IP_NF_TARGET_ECN=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_XATTR=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_HEADERS_INSTALL=n" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_REKERNEL=y" >> ./common/arch/arm64/configs/gki_defconfig
          #Remove check_defconfig
          sudo sed -i 's/check_defconfig//' ./common/build.config.gki

      - name: ğŸ”§ Set Kernel name (è®¾ç½®å†…æ ¸åç§°)
        run: |
          cd kernel_workspace
          echo "å†…æ ¸åç¼€: $DEFAULT_SUFFIX"
          ESCAPED_SUFFIX=$(printf '%s\n' "$DEFAULT_SUFFIX" | sed 's:[\/&]:\\&:g')
          sudo sed -i "s/-4k/$ESCAPED_SUFFIX/g" ./common/arch/arm64/configs/gki_defconfig
          sed -i 's/${scm_version}//' ./common/scripts/setlocalversion
          
      - name: ğŸ”§ Apply Sched Patch (åº”ç”¨å®Œç¾é£é©°è¡¥ä¸)
        run: |
          if [ "$SCHED_FILE" = "none" ]; then
            echo "è¯¥æœºå‹è‡ªå¸¦é£é©°ï¼Œè·³è¿‡åº”ç”¨è¡¥ä¸"
          else
            cd kernel_workspace/common
            if [ "${{ env.ENABLE_FEATURE_Z }}" = "true" ]; then
              git clone https://github.com/Numbersf/SCHED_PATCH.git -b "sm8750"
              echo "æ­£åœ¨æ‹‰å–é£é©°è¡¥ä¸"
              cp ./SCHED_PATCH/fengchi_${{env.SCHED_FILE}}.patch ./
              if [[ -f "fengchi_${{env.SCHED_FILE}}.patch" ]]; then
                echo "å¼€å§‹åº”ç”¨é£é©°è¡¥ä¸"
                dos2unix "fengchi_${{env.SCHED_FILE}}.patch"
                patch -p1 -F 3 < "fengchi_${{env.SCHED_FILE}}.patch"
                echo "å®Œç¾é£é©°è¡¥ä¸åº”ç”¨å®Œæˆ"
              else
                echo "âŒ æœªåŒ¹é…åˆ°è¡¥ä¸ï¼Œé£é©°è¡¥ä¸æš‚æœªæ”¯æŒè¯¥æœºå‹"
                exit 11
              fi
            else
              echo "æœªå¯ç”¨é£é©°ï¼Œåˆ™éœ€åº”ç”¨OGKIè½¬æ¢GKIè¡¥ä¸"
              sed -i '1iobj-y += hmbird_patch.o' drivers/Makefile
               cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/hmbird_patch.patch" ./hmbird_patch.patch
              echo "æ­£åœ¨æ‰“OGKIè½¬æ¢GKIè¡¥ä¸"
              patch -p1 -F 3 < hmbird_patch.patch
              echo "OGKIè½¬æ¢GKI_patchå®Œæˆ"
            fi
          fi

      - name: ğŸ”§ Set Re-Kernel (æ·»åŠ Re-Kernelæ”¯æŒ)
        if: ${{ env.ENABLE_FEATURE_R }}
        run: |
          cd kernel_workspace/common
          echo "æ­£åœ¨æ·»åŠ Re-Kernelæ”¯æŒâ€¦"
          cp "${GITHUB_WORKSPACE}/.github/workflows/Bin/ReKernel.patch" ./ReKernel.patch
          patch -p1 -F 3 < ./ReKernel.patch
          echo "Re-Kernel patchå®Œæˆ"

      - name: ğŸ”¨ Build Kernel (æ„å»ºå†…æ ¸)
        run: |
          WORKDIR="$(pwd)"
          export PATH="/usr/lib/ccache:$PATH"
          export PATH="$WORKDIR/kernel_workspace/clang18/bin:$PATH"
          export PATH="$WORKDIR/kernel_workspace/build-tools/bin:$PATH"
          CLANG_DIR="$WORKDIR/kernel_workspace/clang18/bin"
          CLANG_VERSION="$($CLANG_DIR/clang --version | head -n 1)"
          LLD_VERSION="$($CLANG_DIR/ld.lld --version | head -n 1)"
          pahole_version=$(pahole --version 2>/dev/null | head -n1); [ -z "$pahole_version" ] && echo "paholeç‰ˆæœ¬ï¼šæœªå®‰è£…" || echo "paholeç‰ˆæœ¬ï¼š$pahole_version"
          export CCACHE_LOGFILE="${{ github.workspace }}/kernel_workspace/ccache.log"
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="3G"
          echo "sloppiness = file_stat_matches,include_file_ctime,include_file_mtime,pch_defines,file_macro,time_macros" >> "$CCACHE_DIR/ccache.conf"
          cd kernel_workspace/common
          wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/lib/libfakestat.so
          wget https://github.com/cctv18/oppo_oplus_realme_sm8750/raw/refs/heads/main/lib/libfaketimeMT.so
          chmod 777 ./*.so
          export FAKESTAT="2025-05-25 12:00:00"
          export FAKETIME="@2025-05-25 13:00:00"
          echo "FAKESTAT=$FAKESTAT" >> $GITHUB_ENV
          echo "FAKETIME=$FAKETIME" >> $GITHUB_ENV
          SO_DIR=$(pwd)
          export PRELOAD_LIBS="$SO_DIR/libfakestat.so $SO_DIR/libfaketimeMT.so"
          echo '#!/bin/bash' > cc-wrapper
          echo 'export LD_PRELOAD="'$PRELOAD_LIBS'"' >> cc-wrapper
          echo 'export FAKESTAT="'$FAKESTAT'"' >> cc-wrapper
          echo 'export FAKETIME="'$FAKETIME'"' >> cc-wrapper
          echo 'ccache clang "$@"' >> cc-wrapper
          echo '#!/bin/bash' > ld-wrapper
          echo 'export LD_PRELOAD="'$PRELOAD_LIBS'"' >> ld-wrapper
          echo 'export FAKESTAT="'$FAKESTAT'"' >> ld-wrapper
          echo 'export FAKETIME="'$FAKETIME'"' >> ld-wrapper
          echo 'ld.lld "$@"' >> ld-wrapper
          echo '#!/bin/bash' > test-wrapper.sh
          echo 'export LD_PRELOAD="'$PRELOAD_LIBS'"' >> test-wrapper.sh
          echo 'export FAKESTAT="'$FAKESTAT'"' >> test-wrapper.sh
          echo 'export FAKETIME="'$FAKETIME'"' >> test-wrapper.sh
          echo 'echo ">>> Wrapper å†…éƒ¨ç¯å¢ƒæ£€æŸ¥å®Œæ¯•."' >> test-wrapper.sh
          echo 'exec "$@"' >> test-wrapper.sh
          chmod +x test-wrapper.sh
          ./test-wrapper.sh date
          ./test-wrapper.sh stat ./Makefile
          chmod +x cc-wrapper ld-wrapper
          LD_PRELOAD=$PRELOAD_LIBS stat ./Makefile
          export KBUILD_BUILD_TIMESTAMP="${KERNEL_TIME}"
          sudo rm -rf /usr/share/dotnet &
          sudo rm -rf /usr/local/lib/android &
          sudo rm -rf /opt/ghc &
          sudo rm -rf /opt/hostedtoolcache/CodeQL &
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="ccache clang" LD="ld.lld" HOSTLD=ld.lld O=out KCFLAGS+=-O2 KCFLAGS+=-Wno-error gki_defconfig &&
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC="$(pwd)/cc-wrapper" LD="$(pwd)/ld-wrapper" HOSTLD=ld.lld O=out KCFLAGS+=-O2 KCFLAGS+=-Wno-error Image
          LD_PRELOAD=$PRELOAD_LIBS stat ./Makefile
          echo "ccacheçŠ¶æ€ï¼š"
          ccache -s

      - name: ğŸ“¦ Make AnyKernel3 (åˆ›å»ºAnykernel3)
        run: |
          git clone https://github.com/Anatdx/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          mkdir -p kernel_workspace/out/Final-Image-Find/
          dir1=""
          image_path=$(find "./kernel_workspace/common/out/" -name "Image" | head -n 1)
          if [ -n "$image_path" ]; then
            dir1=$(dirname "$image_path")/
            echo "æˆåŠŸæ‰¾åˆ° Image æ–‡ä»¶"
          else
              echo "æœªæ‰¾åˆ° Image æ–‡ä»¶ï¼Œæ„å»ºå¤±è´¥" >&2
              exit 1
          fi
          if [ -n "$image_path" ] && [ -f "$image_path" ]; then
            echo "Image file finally located at: $image_path"
            cp "$image_path" ./AnyKernel3/Image
            cp "$image_path" kernel_workspace/out/Final-Image-Find/Image
            cd AnyKernel3
            zip -r ../AnyKernel3_SukiSU-Ultra_${{ env.KERNEL_VERSION }}.zip ./*
          fi
          
      - name: ğŸ“¥ Download Latest SukiSU-Ultra APK from CI (ä»CIä¸‹è½½æœ€æ–°çš„SukiSU-Ultraå®‰è£…åŒ…)
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          run_id=$(gh api \
            "repos/SukiSU-Ultra/SukiSU-Ultra/actions/workflows/build-manager.yml/runs?branch=main&status=success&per_page=1" \
            --jq '.workflow_runs[0].id' || echo "")
          if [[ -z "$run_id" ]]; then
            echo "No successful workflow run found. Skipping artifact download."
          else
            artifact_url=$(gh api \
              "repos/SukiSU-Ultra/SukiSU-Ultra/actions/runs/$run_id/artifacts" | \
              jq -r '.artifacts[] | select(.name == "Manager") | .archive_download_url' | head -n1)
            if [[ -z "$artifact_url" ]]; then
              echo "No 'Manager' artifact found in run $run_id. Skipping download."
            else
              echo "Downloading from: $artifact_url"
              curl -fL -H "Authorization: token $GITHUB_TOKEN" -o Manager.zip "$artifact_url"
              unzip -j Manager.zip "*.apk" -d ./APK/
            fi
          fi
          
      - name: ğŸ“¤ Upload AnyKernel3 (ä¸Šä¼  Anykernel3)
        uses: actions/upload-artifact@v4
        with:
         name: AK3
         path: ./*.zip

      - name: ğŸ“¤ Upload APK (ä¸Šä¼  APK)
        uses: actions/upload-artifact@v4
        with:
         name: APK
         path: ./APK/*.apk

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read
      
    steps:
      - name: ğŸ“¥ Download AnyKernel3 (ä¸‹è½½ Anykernel3)
        uses: actions/download-artifact@v4
        with:
          name: AK3
          path: ./release

      - name: ğŸ“¥ Download APK (ä¸‹è½½ APK)
        uses: actions/download-artifact@v4
        with:
          name: APK
          path: ./release

      - name: ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          
          FULL_VERSION=${{ format('{0}.50-{1}', env.TKERNEL_VERSION, env.KERNEL_NAME) }}
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_ENV
          export FULL_VERSION=$FULL_VERSION
          TIME="$(TZ='Asia/Shanghai' date +'%y%m%d%H%M%S')"
          TIME_FORM="$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "TIME=$TIME" >> $GITHUB_ENV
          echo "TIME_FORM=$TIME_FORM" >> $GITHUB_ENV
          TAG_HEAD="Auto-build-for-Ace5Ultra"
          echo "TAG_HEAD=$TAG_HEAD" >> $GITHUB_ENV
          KSU_BRANCH="SukiSU Ultra"
          echo "KSU_BRANCH=$KSU_BRANCH" >> $GITHUB_ENV
         
      - name: ğŸ‰ åˆ›å»ºå‘å¸ƒ
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ env.TAG_HEAD }}-${{ env.TIME }}"
          name: "${{ env.TAG_HEAD }}-${{ env.FULL_VERSION }}"
          body: |
            ### ğŸ“± æ¬§åŠ çœŸ Android 15/16 ${{ env.KSU_BRANCH }}  æ„å»ºä¿¡æ¯
            - å†…æ ¸ç‰ˆæœ¬å·: ${{ env.FULL_VERSION }}
            - ç¼–è¯‘æ—¶é—´: ${{ env.TIME_FORM }}
            - æœºå‹ï¼šæ¬§åŠ çœŸå¤©ç‘9400+ Android 15/16å†…æ ¸é€šç”¨
            - ç‰¹æ€§ï¼š${{ env.KSU_BRANCH }} + SUSFS + é£é©°å†…æ ¸
            - æ¨èç³»ç»Ÿï¼šColorOS 15/16
            ### â«ï¸ æ›´æ–°å†…å®¹ï¼š
            - æ›´æ–°${{ env.KSU_BRANCH }}è‡³æœ€æ–°ç‰ˆæœ¬ï¼ˆ${{ env.KSU_API_VERSION }}ï¼‰
          draft: false
          prerelease: false
          files: |
            release/AnyKernel3*.zip
            release/*.apk